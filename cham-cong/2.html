<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DUKICO – CHẤM CÔNG GHI NHẬT KÝ AUTO</title>
  <!-- TẮT PINCH ZOOM, CHỈ DÙNG ZOOM NÚT + / - -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <!-- Favicon DK -->
  <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAQAAABecRxxAAAMQ0lEQVR4Ae3dQW7cNhAH4Lz/P6x0fgwlHGawEq+y3OCAXoTr4Wr9PXgCulcbkQCk2BEm90LkAMPx/+qvOB0fOkHn2q+49WCo5L+ymsrDgPV1Y6DT+xr3aMcMBXNte1qNbfXDn/YRh+1WDVYqvfdYv59lSV/TSEux33jjDPsegn+09uXBJgp7wa9u0ed7pKnz03Wx/ju0RduCMsZ/HXXdK5vXnhK/HXXdINvODsPwhj/KgOMrgJUgHgdGXNqBJ38qRAjPR9UCeFVLtZL1NVr7DiIP9N6byN1Nsx3Rp3XIan+FJxuxMxDPZWS9Vyuk3F7S3Uz7Dnk3a1WzN96CBvs1+qsSVqSdz+CA0nVddOZXS6jttuPAHyBs+Sn6TfGsDz3jHK5vVsQt1zAr72XdN6Vq776BF3nf6/Dr7guPmyAnbcW2CYwiVdc+GqORdzdrIW6DCe4kYvI0dzdrIpvCMcvrsSLvUXOc6nqBd3YsY9jhY+cxd6jxoX2HFOKRSbuuSSMzdON3vInM8JStybVNewWWm6XtOD87Qy4V/mQJu1WDVYgv3xNmPR9UCeEVHXDekOVoig3NbS1Ry49j8TjuKTzECszO2vCuxnxO8uKszN7N45ofPmbfXE/CyPwiXlL7sRKqzZo4PM5XsfS5aXoaZySUdkddUTkOcZIZyQQ4Ei5IQf3L7hIwrKyYtJ3zKzbw4edvurIWBLL8GMDIS9ZhDJW60F7uO3cu6UytzszbmWzxubUANe0yoyS9MhUlCT3VkOITkkpFmS6r30YIOCQM7DDDeWGPAHDLcGRIDHuBBhdAu+xr3MNx2qCkCmDYJLdnOjFkMrDXLI4sdAlnOzbIRbkIuWGHNirMRHkRkNvztNFVQVw1Gc7YCOUM3FZRMVAbw1Gc7ICOUJXFJRMBw1Gc4bECUkJXFJRMFh1GczYSKUmPCkhIcY7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUlGSeN5e7/geMHdcN1gx9P7h5e8w49AmwlZDlSv8P++/MOA+DDwHoZ8ULICwhfQ3Gscx3NFuIBZpUKoZX6mE6oPD58x35H0TADaBrZEcDgEaKkMfCjRzOQ64rcXeVUsVTNff7kwh28ykVfoWHz0N7dxyzKk5XxhxL7sRKqzo4PM468Odqy0ZOnLT5O20nT2/QY90PLfsvblSsrfxqSdzDCeWkEaKkRBHJCMlmEkmKQypISQUkJTGXOYJISUoJICKWViypISQUkJpG8gJIchICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIIBQUAAAAAAAAAAAAAAAAAAAAD4T/APkjYb9YMRo5AAAAAElFTkSuQmCC">

  <style>
    /* ===== GHI CHÚ MÀU TRẠNG THÁI ===== */
.status-note {
  position: relative;
  overflow: hidden;
  flex: 1;
  font-size: 0.7rem;
  opacity: 0.9;
}

.status-note-track {
  display: flex;
  gap: 24px;
  width: max-content;
  white-space: nowrap;
  animation: status-scroll 45s linear infinite;
}

.status-note-track span {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #cbd5f5;
}

/* dùng lại dot */
.status-note .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}
.status-note .green  { background: #22c55e; }
.status-note .yellow { background: #eab308; }
.status-note .red    { background: #ef4444; }

/* hover dừng trôi */
.status-note:hover .status-note-track {
  animation-play-state: paused;
}

    #siteStatusBar {
  position: fixed;
  left: 0;
  right: 0;
  bottom: env(safe-area-inset-bottom);
  background: rgba(15,23,42,0.96);
  border-top: 1px solid rgba(148,163,184,0.4);
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 10px;
  z-index: 8000;
}

/* ===== TIÊU ĐỀ CỐ ĐỊNH ===== */
.status-title {
  flex: 0 0 auto;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #38bdf8;
  white-space: nowrap;
  padding-right: 8px;
  border-right: 1px solid rgba(148,163,184,0.4);
}

/* ===== KHUNG TRÔI ===== */
.status-marquee {
  position: relative;
  overflow: hidden;
  flex: 1;
}

/* ===== DÒNG TRÔI ===== */
.status-track {
  display: flex;
  gap: 12px;
  width: max-content;
  animation: status-scroll 35s linear infinite;
}

/* ===== ITEM ===== */
.site-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: #020617;
  border: 1px solid rgba(148,163,184,0.4);
  font-size: 0.75rem;
  white-space: nowrap;
  cursor: pointer;
}

/* ===== DOT ===== */
.site-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.dot-green  { background: #22c55e; }
.dot-yellow { background: #eab308; }
.dot-red    { background: #ef4444; }

/* ===== ANIMATION ===== */
@keyframes status-scroll {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(-100%);
  }
}

/* ===== HOVER → DỪNG TRÔI ===== */
.status-marquee:hover .status-track {
  animation-play-state: paused;
}

    :root {
      --bg-main: #020617;
      --bg-panel: #0f172a;
      --accent: #38bdf8;
      --border-soft: rgba(148,163,184,0.5);
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden; /* Không cho kéo ngang cả trang */
    }

    /* ---------- LAYER LOGO ĐANG TẢI DUKICO ---------- */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.92);
      display: none; /* bật/tắt bằng JS */
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }
    .loading-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .loading-logo {
      position: relative;
      width: 90px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loading-ring {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      border: 3px solid rgba(148,163,184,0.4);
      border-top-color: #38bdf8;
      border-right-color: #22c55e;
      animation: loading-spin 0.9s linear infinite;
    }
    .loading-core {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .loading-core span {
      transform: translateX(0.05em);
    }
    .loading-text {
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.9;
    }
    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    /* ---------- LOCK LAYER ---------- */
    #lockScreen {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    #lockBox {
      width: 100%;
      max-width: 340px;
      background: rgba(15,23,42,0.95);
      padding: 22px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.5);
      text-align: center;
    }
    #lockBox h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    #lockBox p {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    #passwordInput {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #475569;
      outline: none;
      background: #020617;
      color: #fff;
      font-size: 0.9rem;
    }
    #passwordError {
      min-height: 18px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #f97373;
      text-align: left;
    }
    #unlockBtn {
      width: 100%;
      margin-top: 8px;
      padding: 9px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      font-size: 0.86rem;
      cursor: pointer;
    }

    /* ---------- HEADER ---------- */
    header {
      padding: 8px 10px 6px;
      background: rgba(15,23,42,0.98);
      border-bottom: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-mark {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(#38bdf8,#22c55e,#f97316,#eab308,#38bdf8);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .brand-inner {
      width: 100%;
      height: 100%;
      border-radius: 6px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: #38bdf8;
      font-weight: 700;
      letter-spacing: 0.12em;
    }
    .brand span {
      font-size: 0.9rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* ===== TOOLBAR – THU NHỎ CHO VÀO 1 HÀNG ===== */
    .toolbar {
      display: flex;
      gap: 4px;
      flex-wrap: nowrap;          /* Không cho xuống dòng */
      overflow-x: auto;           /* Vuốt ngang nếu chật */
      padding-bottom: 4px;
    }

    select,
    button.small-btn {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 5px 6px;
    }

    select {
      flex: 1 1 auto;             /* Cho tự co lại */
      min-width: 90px;            /* Thu hẹp để dễ nằm 1 hàng */
    }

    button.small-btn {
      flex: 0 0 auto;
      cursor: pointer;
      white-space: nowrap;
      padding: 5px 8px;
    }

    /* Nút SỬA – chỉ hiện trên màn nhỏ (mobile) */
    #editBtn {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
      display: inline-block;
    }
    @media (min-width: 768px) {
      #editBtn {
        display: none;
      }
    }

    main {
      flex: 1;
      padding: 6px;
      display: flex;
      min-height: 0;
    }
    .viewer {
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      display: flex;
      flex-direction: column;
    }

    /* KHUNG CHO PHÉP KÉO NGANG + DỌC - GIỜ CHỈ MỞ NGANG KHI ZOOM > 1 (JS LO HANDLE) */
    .iframe-wrap {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;              /* mặc định: KHÔNG cho kéo ngang để tránh vùng đen */
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;             /* ưu tiên cuộn dọc */
    }
    .iframe-scale {
      transform-origin: top left;
      width: 1200px;  /* chiều rộng gốc của sheet */
      min-height: 600px;
    }
    iframe {
      width: 100%;
      height: 100vh;
      border: none;
      background: #020617;
    }

    @media (min-width: 768px) {
      header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
      }
      .toolbar {
        overflow-x: visible;
      }
      main { padding: 10px; }
    }
    /* ========== WRAPPER NEO ĐÁY ========== */
#statusWrapper {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9000;
  pointer-events: none;
}

/* ========== THANH TRẠNG THÁI ========== */
#siteStatusBar {
  pointer-events: auto;
  height: 44px;
  background: rgba(15,23,42,0.95);
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(148,163,184,0.25);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 12px;
  font-size: 13px;
}

/* ========== BIỂU ĐỒ – NẰM TRÊN STATUS ========== */
#statusDashboard {
  pointer-events: auto;
  position: absolute;
  left: 0;
  right: 0;
  bottom: 44px; /* CHÌA KHÓA: luôn nằm trên status */
  background: rgba(2,6,23,0.92);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(148,163,184,0.25);

  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s cubic-bezier(.4,0,.2,1);
}

/* PC – MỞ KHI CÓ CLASS */
#statusWrapper.open #statusDashboard {
  max-height: 180px;
}

/* MOBILE – LUÔN MỞ */
@media (max-width: 1023px) {
  #statusDashboard {
    max-height: 180px;
  }
  #toggleDashBtn {
    display: none;
  }
}

/* NÚT PC */
#toggleDashBtn {
  background: none;
  border: none;
  color: #38bdf8;
  cursor: pointer;
}
/* ===== MOBILE: CỘT ĐỨNG ===== */
#mobileChart {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  padding: 10px;
  height: 140px;
  overflow-x: auto;
}

.m-col {
  width: 28px;
  border-radius: 6px 6px 0 0;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}

.m-col span {
  font-size: 10px;
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  margin-bottom: 4px;
  color: #020617;
  font-weight: 600;
}

/* ===== PC: THANH NGANG ===== */
#pcChart {
  display: none;
  padding: 10px 14px;
}

.pc-row {
  display: grid;
  grid-template-columns: 90px 1fr;
  gap: 10px;
  align-items: center;
  margin: 6px 0;
}

.pc-bar {
  height: 10px;
  border-radius: 999px;
}

/* SWITCH PC */
@media (min-width: 1024px) {
  #mobileChart { display: none; }
  #pcChart { display: block; }
}

  </style>
</head>
<body>

<!-- LAYER LOGO ĐANG TẢI DUKICO -->
<div id="loadingOverlay">
  <div class="loading-box">
    <div class="loading-logo">
      <div class="loading-ring"></div>
      <div class="loading-core">
        <span>DUKICO</span>
      </div>
    </div>
    <div class="loading-text">Đợi 10 giây...</div>
  </div>
</div>

<!-- LAYER MẬT KHẨU -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>Mật khẩu</h2>
    <p>Nhập mật khẩu để mở viewer.</p>
    <input id="passwordInput" type="password" placeholder="Mật khẩu..." />
    <div id="passwordError"></div>
    <button id="unlockBtn">MỞ</button>
  </div>
</div>

<!-- HEADER CHÍNH -->
<header id="topBar" style="display:none;">
  <div class="brand">
    <div class="brand-mark"><div class="brand-inner">DKC</div></div>
    <span>DUKICO – Chấm công ghi nhật ký auto</span>
  </div>

  <div class="toolbar">
    <select id="fileMenu"></select>
    <select id="sheetMenu"></select>
    <button id="editBtn" class="small-btn">Sửa</button>
    <button id="driveBtn" class="small-btn">Drive</button>
    <button id="zoomOutBtn" class="small-btn">−</button>
    <button id="zoomInBtn" class="small-btn">+</button>
  </div>
</header>

<main>
  <div class="viewer">
    <div class="iframe-wrap">
      <div class="iframe-scale" id="iframeScale">
        <iframe id="sheetFrame"></iframe>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbzAq6ients1L8wi0QZzDfSJEo9ImOHzV5rchXlssye7xip5PekwBR2T2B5sVkW9fHac/exec";
const PASSWORD = "123";
const AUTH_KEY = "dukico_viewer_auth_v1";
const BASE_WIDTH = 1200;

/* ===== DOM ===== */
const lockScreen    = document.getElementById("lockScreen");
const passwordInput = document.getElementById("passwordInput");
const passwordError = document.getElementById("passwordError");
const unlockBtn     = document.getElementById("unlockBtn");

const loadingOverlay = document.getElementById("loadingOverlay");

const topBar    = document.getElementById("topBar");
const fileMenu  = document.getElementById("fileMenu");
const sheetMenu = document.getElementById("sheetMenu");
const editBtn   = document.getElementById("editBtn");
const driveBtn  = document.getElementById("driveBtn");
const zoomOutBtn = document.getElementById("zoomOutBtn");
const zoomInBtn  = document.getElementById("zoomInBtn");
const frame     = document.getElementById("sheetFrame");
const iframeScaleDiv = document.getElementById("iframeScale");
const siteStatusBar = document.getElementById("siteStatusBar");
const statusList    = document.getElementById("statusList");

/* ===== ZOOM STATE ===== */
let baseScale = 1;       // scale theo màn hình
let zoomMultiplier = 1;  // user chỉnh thêm (0.5 → 2)

/* ===== LOADING HELPERS ===== */
function showLoading() {
  loadingOverlay.style.display = "flex";
}
function hideLoading() {
  loadingOverlay.style.display = "none";
}

/* Khi iframe load xong thì tắt logo tải */
frame.addEventListener("load", () => {
  if (frame.src && frame.src !== "about:blank") {
    hideLoading();
  }
});

/* ===== INIT: AUTO UNLOCK NẾU ĐÃ LƯU ===== */
window.addEventListener("load", () => {
  try {
    const auth = localStorage.getItem(AUTH_KEY);
    if (auth === "ok") {
      startApp();
      return;
    }
  } catch (e) {}
});

/* ===== PASSWORD ===== */
unlockBtn.onclick = handleUnlock;
passwordInput.onkeydown = (e) => { if (e.key === "Enter") handleUnlock(); };

function handleUnlock() {
  const pass = passwordInput.value.trim();
  if (pass === PASSWORD) {
    try {
      localStorage.setItem(AUTH_KEY, "ok");
    } catch (e) {}
    startApp();
  } else {
    passwordError.textContent = "Sai mật khẩu!";
  }
}

function startApp() {
  passwordError.textContent = "";
  lockScreen.style.display = "none";
  topBar.style.display = "flex";
  showLoading();
  loadFiles();
  autoScaleIframe();
}

/* ===== APPLY SCALE ===== */
function applyScale() {
  if (!iframeScaleDiv) return;
  const scale = baseScale * zoomMultiplier;
  iframeScaleDiv.style.transform = "scale(" + scale + ")";

  // ⭐ TỰ ĐỘNG BẬT/TẮT CUỘN NGANG THEO ZOOM
  const wrap = document.querySelector(".iframe-wrap");
  if (wrap) {
    if (zoomMultiplier > 1) {
      // zoom > 1: cho vuốt ngang để xem hết sheet
      wrap.style.overflowX = "auto";
      wrap.style.touchAction = "pan-x pan-y";
    } else {
      // zoom = 1: tắt ngang, tránh kéo ra thấy vùng đen
      wrap.style.overflowX = "hidden";
      wrap.style.touchAction = "pan-y";
    }
  }
}

/* ===== AUTO SCALE THEO MÀN HÌNH ===== */
function autoScaleIframe() {
  if (!iframeScaleDiv) return;
  const screenW = window.innerWidth || document.documentElement.clientWidth;
  baseScale = Math.min(1, screenW / BASE_WIDTH); // PC không phóng to quá 1
  applyScale();
}

window.addEventListener("resize", autoScaleIframe);

/* ===== NÚT ZOOM +/- ===== */
function changeZoom(delta) {
  zoomMultiplier += delta;
  if (zoomMultiplier < 1) zoomMultiplier = 1;
  if (zoomMultiplier > 4)   zoomMultiplier = 4;
  applyScale();
}

zoomOutBtn.onclick = () => changeZoom(-0.1);
zoomInBtn.onclick  = () => changeZoom(+0.1);

/* ===== UTIL ===== */
function extractSheetId(url) {
  if (!url) return null;
  const m = String(url).match(/\/d\/([a-zA-Z0-9\-_]+)/);
  return m ? m[1] : null;
}

function isCurrentMonthValue(val, curM, curY) {
  if (!val) return false;

  if (val instanceof Date) {
    return (val.getMonth() + 1 === curM) && (val.getFullYear() === curY);
  }

  const s = String(val).trim();

  let m = s.match(/^(\d{1,2})\s*[\/\-]\s*(\d{4})$/);
  if (m) {
    const month = parseInt(m[1], 10);
    const year  = parseInt(m[2], 10);
    return month === curM && year === curY;
  }

  m = s.match(/^(\d{4})\s*[\/\-]\s*(\d{1,2})$/);
  if (m) {
    const year  = parseInt(m[1], 10);
    const month = parseInt(m[2], 10);
    return month === curM && year === curY;
  }

  m = s.match(/Tháng\s*(\d{1,2})\s*[\/\-]?\s*(\d{4})?/i);
  if (m) {
    const month = parseInt(m[1], 10);
    const year  = m[2] ? parseInt(m[2], 10) : curY;
    return month === curM && year === curY;
  }

  return false;
}

/* ===== LOAD FILES ===== */
async function loadFiles() {
  showLoading();
  try {
    const res  = await fetch(API_URL + "?action=files");
    const json = await res.json();
    const list = Array.isArray(json) ? json : (json.files || []);

    fileMenu.innerHTML = "";

    const now  = new Date();
    const curM = now.getMonth() + 1;
    const curY = now.getFullYear();
    let defaultIndex = 0;

    list.forEach((item, idx) => {
      const name = item.name || item.label || ("Dòng " + (item.rowIndex || ""));
      const url  = item.url;
      if (!url) return;

      const op = document.createElement("option");
      op.value = url;
      op.textContent = name;
      fileMenu.appendChild(op);

      const monthVal = item.month || item.thang || item.A || null;
      if (monthVal && isCurrentMonthValue(monthVal, curM, curY)) {
        defaultIndex = idx;
      }
    });

    if (fileMenu.options.length > 0) {
      fileMenu.selectedIndex = defaultIndex;
      await loadSheetsForCurrentFile();
    } else {
      hideLoading();
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi tải danh sách file từ API.");
    hideLoading();
  }
}

/* ===== LOAD SHEETS ===== */
async function loadSheetsForCurrentFile() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) {
    hideLoading();
    return;
  }

  const id = extractSheetId(fileUrl);
  if (!id) {
    sheetMenu.innerHTML = "";
    hideLoading();
    return;
  }

  showLoading();
  try {
    const res  = await fetch(API_URL + "?action=sheets&fileId=" + encodeURIComponent(id));
const data = await res.json();

const tabs  = data.sheets || [];
const sites = data.sites  || [];

renderSiteStatus(sites);   // ⭐ BẮT BUỘC

sheetMenu.innerHTML = "";

const today = new Date();
const day   = today.getDate();
const preferredName = (day <= 15) ? "Ngày 1 đến 15" : "Ngày 16 đến 31";
let preferredGid = null;

tabs.forEach(t => {

      const op = document.createElement("option");
      op.value = t.gid;
      op.textContent = t.name;
      sheetMenu.appendChild(op);

      if (!preferredGid && t.name === preferredName) {
        preferredGid = t.gid;
      }
    });

    if (sheetMenu.options.length > 0) {
      if (preferredGid) {
        sheetMenu.value = preferredGid;
      } else {
        sheetMenu.selectedIndex = 0;
      }
      updateFrame();
    } else {
      hideLoading();
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi tải danh sách sheet/tabs.");
    hideLoading();
  }
}

/* ===== BUILD URL EDIT#GID ===== */
function buildEditUrl() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) return "";

  const id  = extractSheetId(fileUrl);
  const gid = sheetMenu.value || "";
  if (!id) return fileUrl;

  return `https://docs.google.com/spreadsheets/d/${id}/edit#gid=${gid}`;
}

/* ===== UPDATE IFRAME ===== */
function updateFrame() {
  const url = buildEditUrl();
  if (url) {
    showLoading();
    frame.src = url;
    setTimeout(autoScaleIframe, 300);
  }
}

fileMenu.onchange  = () => { loadSheetsForCurrentFile(); };
sheetMenu.onchange = updateFrame;

/* ===== NÚT SỬA (MOBILE) ===== */
editBtn.onclick = () => {
  const url = buildEditUrl();
  if (url) window.open(url, "_blank");
};

/* ===== NÚT THƯ MỤC DRIVE ===== */
driveBtn.onclick = () => {
  window.open("https://drive.google.com/drive/folders/1o3n5GABxec53ANpnS_OaDU1w0M3cGeAX?usp=sharing", "_blank");
};
  function renderSiteStatus(sites) {
  const bar  = document.getElementById("siteStatusBar");
  const list = document.getElementById("statusList");

  list.innerHTML = "";
  if (!sites.length) {
    bar.style.display = "none";
    return;
  }

  sites.forEach(s => {
    const dot =
      s.status === "green"  ? "dot-green" :
      s.status === "yellow" ? "dot-yellow" :
                              "dot-red";

    const el = document.createElement("div");
    el.className = "site-item";
    el.innerHTML = `
      <span class="site-dot ${dot}"></span>
      <strong>${s.maCan}</strong>
    `;

    el.onclick = () => {
      sheetMenu.value = s.gid;
      updateFrame();
    };

    list.appendChild(el);
  });

  bar.style.display = "block";
}
function renderSiteActivityChart(sites) {
  const mobile = document.getElementById("mobileChart");
  const pc = document.getElementById("pcChart");
  if (!mobile || !pc || !sites) return;

  mobile.innerHTML = "";
  pc.innerHTML = "";

  sites.forEach(site => {
    const score =
      site.status === "green"  ? 100 :
      site.status === "yellow" ? 60  : 25;

    const color =
      site.status === "green"  ? "#22c55e" :
      site.status === "yellow" ? "#eab308" :
                                 "#ef4444";

    /* MOBILE */
    const col = document.createElement("div");
    col.className = "m-col";
    col.style.height = score + "%";
    col.style.background = color;
    col.innerHTML = `<span>${site.maCan}</span>`;
    mobile.appendChild(col);

    /* PC */
    const row = document.createElement("div");
    row.className = "pc-row";
    row.innerHTML = `
      <div>${site.maCan}</div>
      <div class="pc-bar" style="width:${score}%;background:${color}"></div>
    `;
    pc.appendChild(row);
  });
}
window.addEventListener("load", () => {
  const wrapper = document.getElementById("statusWrapper");
  const btn = document.getElementById("toggleDashBtn");
  if (!wrapper || !btn) return;

  btn.onclick = () => {
    const open = wrapper.classList.toggle("open");
    btn.textContent = open ? "▼" : "▲";
  };
});
renderSiteStatus(sites);
renderSiteActivityChart(sites);

</script>
  <!-- STATUS + DASHBOARD -->
<div id="statusWrapper">

  <!-- BIỂU ĐỒ (TRƯỢT LÊN TỪ STATUS) -->
  <div id="statusDashboard">
    <div id="mobileChart"></div>
    <div id="pcChart"></div>
  </div>

  <!-- THANH TRẠNG THÁI -->
  <div id="siteStatusBar">
    <span class="status-title">CÔNG TRƯỜNG ĐANG HOẠT ĐỘNG</span>

    <button id="toggleDashBtn" aria-label="Mở/Đóng biểu đồ">▲</button>

    <div class="status-marquee">
      <div id="statusList"></div>
   
  </div>

  <!-- GHI CHÚ MÀU -->
  <div class="status-note">
    <div class="status-note-track">
      <span><i class="dot green"></i> Xanh: Hôm nay và hôm qua</span>
      <span><i class="dot yellow"></i> Vàng: 1 ngày không thi công</span>
      <span><i class="dot red"></i> Đỏ: Trên 2 ngày không thi công</span>
    </div>
  </div>
</div>

</body>
</html>
