<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DUKICO ‚Äì CH·∫§M C√îNG GHI NH·∫¨T K√ù AUTO</title>
  <!-- T·∫ÆT PINCH ZOOM, CH·ªà D√ôNG ZOOM N√öT + / - -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <!-- Favicon DK -->
  <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAQAAABecRxxAAAMQ0lEQVR4Ae3dQW7cNhAH4Lz/P6x0fgwlHGawEq+y3OCAXoTr4Wr9PXgCulcbkQCk2BEm90LkAMPx/+qvOB0fOkHn2q+49WCo5L+ymsrDgPV1Y6DT+xr3aMcMBXNte1qNbfXDn/YRh+1WDVYqvfdYv59lSV/TSEux33jjDPsegn+09uXBJgp7wa9u0ed7pKnz03Wx/ju0RduCMsZ/HXXdK5vXnhK/HXXdINvODsPwhj/KgOMrgJUgHgdGXNqBJ38qRAjPR9UCeFVLtZL1NVr7DiIP9N6byN1Nsx3Rp3XIan+FJxuxMxDPZWS9Vyuk3F7S3Uz7Dnk3a1WzN96CBvs1+qsSVqSdz+CA0nVddOZXS6jttuPAHyBs+Sn6TfGsDz3jHK5vVsQt1zAr72XdN6Vq776BF3nf6/Dr7guPmyAnbcW2CYwiVdc+GqORdzdrIW6DCe4kYvI0dzdrIpvCMcvrsSLvUXOc6nqBd3YsY9jhY+cxd6jxoX2HFOKRSbuuSSMzdON3vInM8JStybVNewWWm6XtOD87Qy4V/mQJu1WDVYgv3xNmPR9UCeEVHXDekOVoig3NbS1Ry49j8TjuKTzECszO2vCuxnxO8uKszN7N45ofPmbfXE/CyPwiXlL7sRKqzZo4PM5XsfS5aXoaZySUdkddUTkOcZIZyQQ4Ei5IQf3L7hIwrKyYtJ3zKzbw4edvurIWBLL8GMDIS9ZhDJW60F7uO3cu6UytzszbmWzxubUANe0yoyS9MhUlCT3VkOITkkpFmS6r30YIOCQM7DDDeWGPAHDLcGRIDHuBBhdAu+xr3MNx2qCkCmDYJLdnOjFkMrDXLI4sdAlnOzbIRbkIuWGHNirMRHkRkNvztNFVQVw1Gc7YCOUM3FZRMVAbw1Gc7ICOUJXFJRMBw1Gc4bECUkJXFJRMFh1GczYSKUmPCkhIcY7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUlGSeN5e7/geMHdcN1gx9P7h5e8w49AmwlZDlSv8P++/MOA+DDwHoZ8ULICwhfQ3Gscx3NFuIBZpUKoZX6mE6oPD58x35H0TADaBrZEcDgEaKkMfCjRzOQ64rcXeVUsVTNff7kwh28ykVfoWHz0N7dxyzKk5XxhxL7sRKqzo4PM468Odqy0ZOnLT5O20nT2/QY90PLfsvblSsrfxqSdzDCeWkEaKkRBHJCMlmEkmKQypISQUkJTGXOYJISUoJICKWViypISQUkJpG8gJIchICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIIBQUAAAAAAAAAAAAAAAAAAAAD4T/APkjYb9YMRo5AAAAAElFTkSuQmCC">

  <style>
    /* ===== GHI CH√ö M√ÄU TR·∫†NG TH√ÅI ===== */
.status-note {
  position: relative;
  overflow: hidden;
  flex: 1;
  font-size: 0.7rem;
  opacity: 0.9;
}

.status-note-track {
  display: flex;
  gap: 24px;
  width: max-content;
  white-space: nowrap;
  animation: status-scroll 55s linear infinite;
}

.status-note-track span {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #cbd5f5;
}

/* hover d·ª´ng tr√¥i */
.status-note:hover .status-note-track {
  animation-play-state: paused;
}

    #siteStatusBar {
  position: fixed;
  left: 0;
  right: 0;
  bottom: env(safe-area-inset-bottom);
  background: rgba(15,23,42,0.96);
  border-top: 1px solid rgba(148,163,184,0.4);
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 10px;
  z-index: 8000;
}

/* ===== TI√äU ƒê·ªÄ C·ªê ƒê·ªäNH ===== */
.status-title {
  flex: 0 0 auto;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #38bdf8;
  white-space: nowrap;
  padding-right: 8px;
  border-right: 1px solid rgba(148,163,184,0.4);
}

/* ===== KHUNG TR√îI ===== */
.status-marquee {
  position: relative;
  overflow: hidden;
  flex: 1;
}

/* ===== D√íNG TR√îI ===== */
.status-track {
  display: flex;
  gap: 12px;
  width: max-content;
  animation: status-scroll 35s linear infinite;
}

/* ===== ITEM ===== */
.site-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: #020617;
  border: 1px solid rgba(148,163,184,0.4);
  font-size: 0.75rem;
  white-space: nowrap;
  cursor: pointer;
}

/* ===== DOT ===== */
.site-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.dot-green  { background: #22c55e; }
.dot-yellow { background: #eab308; }
.dot-red    { background: #ef4444; }

/* ===== ANIMATION ===== */
@keyframes status-scroll {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(-100%);
  }
}
@keyframes note-scroll {
  from { transform: translateX(0); }
  to   { transform: translateX(-100%); }
}

.status-note-dynamic {
  animation: note-scroll 45s linear infinite;
}

/* ===== HOVER ‚Üí D·ª™NG TR√îI ===== */
.status-marquee:hover .status-track {
  animation-play-state: paused;
}

    :root {
      --bg-main: #020617;
      --bg-panel: #0f172a;
      --accent: #38bdf8;
      --border-soft: rgba(148,163,184,0.5);
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden; /* Kh√¥ng cho k√©o ngang c·∫£ trang */
    }

    /* ===== LOADING OVERLAY ===== */
#loadingOverlay {
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,0.92);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* ===== WRAP ===== */
.loading-wrap {
  position: relative;
  width: 140px;
  height: 140px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 14px;
}

/* ===== RING ===== */
.loading-ring {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid rgba(148,163,184,0.35);
  border-top-color: #38bdf8;
  border-right-color: #22c55e;
  animation: loading-spin 1.2s linear infinite;
}

/* ===== CORE ===== */
.loading-core {
  width: 116px;
  height: 60px;
  border-radius: 14px;
  background: #020617;
  border: 1px solid rgba(148,163,184,0.7);

  display: flex;
  align-items: center;
  justify-content: center;

  z-index: 2;
  overflow: hidden;
}

/* ===== LOGO DUKICO ===== */
.dukico-logo {
  font-family: system-ui, "Arial Black", sans-serif;
  font-size: 23px;
  font-weight: 900;
  line-height: 1;
  letter-spacing: 0.04em;
  white-space: nowrap;
  text-transform: uppercase;
  transform: translateX(3px); /* c√¢n th·ªã gi√°c U‚ÄìK */

  background: linear-gradient(
    to bottom,
    #caffb8 0%,
    #7dff5a 45%,
    #2dbb1f 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;

  
}

/* ===== U + K CHUNG N√âT ===== */
.dukico-logo .uk {
  display: inline-block;
}

.dukico-logo .u {
  display: inline-block;
}

.dukico-logo .k {
  display: inline-block;
  margin-left: -0.34em;
  transform: scaleX(1.05);
}

/* ===== TEXT ===== */
.loading-text {
  font-size: 0.7rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #e5e7eb;
  opacity: 0.9;
}

/* ===== ANIMATION ===== */
@keyframes loading-spin {
  to { transform: rotate(360deg); }
}

    /* ---------- LOCK LAYER ---------- */
    #lockScreen {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    #lockBox {
      width: 100%;
      max-width: 340px;
      background: rgba(15,23,42,0.95);
      padding: 22px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.5);
      text-align: center;
    }
    #lockBox h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    #lockBox p {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    #passwordInput {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #475569;
      outline: none;
      background: #020617;
      color: #fff;
      font-size: 0.9rem;
    }
    #passwordError {
      min-height: 18px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #f97373;
      text-align: left;
    }
    #unlockBtn {
      width: 100%;
      margin-top: 8px;
      padding: 9px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      font-size: 0.86rem;
      cursor: pointer;
    }

    /* ---------- HEADER ---------- */
    header {
      padding: 8px 10px 6px;
      background: rgba(15,23,42,0.98);
      border-bottom: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-mark {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(#38bdf8,#22c55e,#f97316,#eab308,#38bdf8);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .brand-inner {
      width: 100%;
      height: 100%;
      border-radius: 6px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: #38bdf8;
      font-weight: 700;
      letter-spacing: 0.12em;
    }
    .brand span {
      font-size: 0.9rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* ===== TOOLBAR ‚Äì THU NH·ªé CHO V√ÄO 1 H√ÄNG ===== */
    .toolbar {
      display: flex;
      gap: 4px;
      flex-wrap: nowrap;          /* Kh√¥ng cho xu·ªëng d√≤ng */
      overflow-x: auto;           /* Vu·ªët ngang n·∫øu ch·∫≠t */
      padding-bottom: 4px;
    }

    select,
    button.small-btn {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 5px 6px;
    }

    select {
      flex: 1 1 auto;             /* Cho t·ª± co l·∫°i */
      min-width: 90px;            /* Thu h·∫πp ƒë·ªÉ d·ªÖ n·∫±m 1 h√†ng */
    }

    button.small-btn {
      flex: 0 0 auto;
      cursor: pointer;
      white-space: nowrap;
      padding: 5px 8px;
    }

    /* N√∫t S·ª¨A ‚Äì ch·ªâ hi·ªán tr√™n m√†n nh·ªè (mobile) */
    #editBtn {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
      display: inline-block;
    }
    @media (min-width: 768px) {
      #editBtn {
        display: none;
      }
    }

    main {
      flex: 1;
      padding: 6px;
      display: flex;
      min-height: 0;
    }
    .viewer {
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      display: flex;
      flex-direction: column;
    }

    /* KHUNG CHO PH√âP K√âO NGANG + D·ªåC - GI·ªú CH·ªà M·ªû NGANG KHI ZOOM > 1 (JS LO HANDLE) */
    .iframe-wrap {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;              /* m·∫∑c ƒë·ªãnh: KH√îNG cho k√©o ngang ƒë·ªÉ tr√°nh v√πng ƒëen */
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;             /* ∆∞u ti√™n cu·ªôn d·ªçc */
    }
    .iframe-scale {
      transform-origin: top left;
      width: 1200px;  /* chi·ªÅu r·ªông g·ªëc c·ªßa sheet */
      min-height: 600px;
    }
    iframe {
      width: 100%;
      height: 100vh;
      border: none;
      background: #020617;
    }

    @media (min-width: 768px) {
      header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
      }
      .toolbar {
        overflow-x: visible;
      }
      main { padding: 10px; }
    }
  /* tr·∫°ng th√°i CH∆ØA CH·∫†Y */
.status-note-track.paused {
  animation-play-state: paused;
}
  
  </style>
</head>
<body>
<!-- ===== LOADING OVERLAY ‚Äì CLEAN ===== -->
<div id="loadingOverlay">
  <div class="loading-wrap">
    <div class="loading-ring"></div>

    <div class="loading-core">
      <div class="dukico-logo">
        D<span class="uk">
          <span class="u">U</span><span class="k">K</span>
        </span>ICO
      </div>
    </div>

    <div class="loading-text">ƒêANG T·∫¢I D·ªÆ LI·ªÜU‚Ä¶</div>
  </div>
</div>

<!-- LAYER M·∫¨T KH·∫®U -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>M·∫≠t kh·∫©u</h2>
    <p>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü viewer.</p>
    <input id="passwordInput" type="password" placeholder="M·∫≠t kh·∫©u..." />
    <div id="passwordError"></div>
    <button id="unlockBtn">M·ªû</button>
  </div>
</div>

<!-- HEADER CH√çNH -->
<header id="topBar" style="display:none;">
  <div class="brand">
    <div class="brand-mark"><div class="brand-inner">DKC</div></div>
    <span>DUKICO ‚Äì Ch·∫•m c√¥ng ghi nh·∫≠t k√Ω auto</span>
  </div>

  <div class="toolbar">
    <select id="fileMenu"></select>
    <select id="sheetMenu"></select>
    <button id="editBtn" class="small-btn">S·ª≠a</button>
    <button id="driveBtn" class="small-btn">Drive</button>
    <button id="zoomOutBtn" class="small-btn">‚àí</button>
    <button id="zoomInBtn" class="small-btn">+</button>
  </div>
</header>

<main>
  <div class="viewer">
    <div class="iframe-wrap">
      <div class="iframe-scale" id="iframeScale">
        <iframe id="sheetFrame"></iframe>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbzZRE8_2j2Tgk5w0QRHmAC2ertSS1G4jeG8U0KoYyo6KdaabekkW7GITgwv9uDaF9X5/exec";
const PASSWORD = "123";
const AUTH_KEY = "dukico_viewer_auth_v1";
const BASE_WIDTH = 1200;

/* ===== DOM ===== */
const lockScreen    = document.getElementById("lockScreen");
const passwordInput = document.getElementById("passwordInput");
const passwordError = document.getElementById("passwordError");
const unlockBtn     = document.getElementById("unlockBtn");
const loadingOverlay = document.getElementById("loadingOverlay");
const topBar    = document.getElementById("topBar");
const fileMenu  = document.getElementById("fileMenu");
const sheetMenu = document.getElementById("sheetMenu");
const editBtn   = document.getElementById("editBtn");
const driveBtn  = document.getElementById("driveBtn");
const zoomOutBtn = document.getElementById("zoomOutBtn");
const zoomInBtn  = document.getElementById("zoomInBtn");
const frame     = document.getElementById("sheetFrame");
const iframeScaleDiv = document.getElementById("iframeScale");
const siteStatusBar = document.getElementById("siteStatusBar");
const statusList    = document.getElementById("statusList");
/* ===== ZOOM STATE ===== */
let baseScale = 1;       // scale theo m√†n h√¨nh
let zoomMultiplier = 1;  // user ch·ªânh th√™m (0.5 ‚Üí 2)

/* ===== LOADING HELPERS ===== */
function showLoading() {
  loadingOverlay.style.display = "flex";
}
function hideLoading() {
  loadingOverlay.style.display = "none";

  // ‚≠ê B√ÅO HI·ªÜU: LOGO ƒê√É BI·∫æN M·∫§T
  document.dispatchEvent(new Event("dukico-loading-hidden"));
}

/* Khi iframe load xong th√¨ t·∫Øt logo t·∫£i */
frame.addEventListener("load", () => {
  if (frame.src && frame.src !== "about:blank") {
    hideLoading();

    // ‚≠ê cho d√≤ng ghi ch√∫ b·∫Øt ƒë·∫ßu tr√¥i SAU khi load xong
    setTimeout(() => {
      const note = document.getElementById("statusNoteDynamic");
      if (note) {
        note.classList.remove("paused");
      }
    }, 300);
  }
});


/* ===== INIT: AUTO UNLOCK N·∫æU ƒê√É L∆ØU ===== */
window.addEventListener("load", () => {
  try {
    const auth = localStorage.getItem(AUTH_KEY);
    if (auth === "ok") {
      startApp();
      return;
    }
  } catch (e) {}
});

/* ===== PASSWORD ===== */
unlockBtn.onclick = handleUnlock;
passwordInput.onkeydown = (e) => { if (e.key === "Enter") handleUnlock(); };

function handleUnlock() {
  const pass = passwordInput.value.trim();
  if (pass === PASSWORD) {
    try {
      localStorage.setItem(AUTH_KEY, "ok");
    } catch (e) {}
    startApp();
  } else {
    passwordError.textContent = "Sai m·∫≠t kh·∫©u!";
  }
}

function startApp() {
  passwordError.textContent = "";
  lockScreen.style.display = "none";
  topBar.style.display = "flex";
  showLoading();
  loadFiles();
  autoScaleIframe();
}

/* ===== APPLY SCALE ===== */
function applyScale() {
  if (!iframeScaleDiv) return;
  const scale = baseScale * zoomMultiplier;
  iframeScaleDiv.style.transform = "scale(" + scale + ")";

  // ‚≠ê T·ª∞ ƒê·ªòNG B·∫¨T/T·∫ÆT CU·ªòN NGANG THEO ZOOM
  const wrap = document.querySelector(".iframe-wrap");
  if (wrap) {
    if (zoomMultiplier > 1) {
      // zoom > 1: cho vu·ªët ngang ƒë·ªÉ xem h·∫øt sheet
      wrap.style.overflowX = "auto";
      wrap.style.touchAction = "pan-x pan-y";
    } else {
      // zoom = 1: t·∫Øt ngang, tr√°nh k√©o ra th·∫•y v√πng ƒëen
      wrap.style.overflowX = "hidden";
      wrap.style.touchAction = "pan-y";
    }
  }
}

/* ===== AUTO SCALE THEO M√ÄN H√åNH ===== */
function autoScaleIframe() {
  if (!iframeScaleDiv) return;
  const screenW = window.innerWidth || document.documentElement.clientWidth;
  baseScale = Math.min(1, screenW / BASE_WIDTH); // PC kh√¥ng ph√≥ng to qu√° 1
  applyScale();
}

window.addEventListener("resize", autoScaleIframe);

/* ===== N√öT ZOOM +/- ===== */
function changeZoom(delta) {
  zoomMultiplier += delta;
  if (zoomMultiplier < 1) zoomMultiplier = 1;
  if (zoomMultiplier > 4)   zoomMultiplier = 4;
  applyScale();
}

zoomOutBtn.onclick = () => changeZoom(-0.1);
zoomInBtn.onclick  = () => changeZoom(+0.1);

/* ===== UTIL ===== */
function extractSheetId(url) {
  if (!url) return null;
  const m = String(url).match(/\/d\/([a-zA-Z0-9\-_]+)/);
  return m ? m[1] : null;
}

function isCurrentMonthValue(val, curM, curY) {
  if (!val) return false;

  if (val instanceof Date) {
    return (val.getMonth() + 1 === curM) && (val.getFullYear() === curY);
  }

  const s = String(val).trim();

  let m = s.match(/^(\d{1,2})\s*[\/\-]\s*(\d{4})$/);
  if (m) {
    const month = parseInt(m[1], 10);
    const year  = parseInt(m[2], 10);
    return month === curM && year === curY;
  }

  m = s.match(/^(\d{4})\s*[\/\-]\s*(\d{1,2})$/);
  if (m) {
    const year  = parseInt(m[1], 10);
    const month = parseInt(m[2], 10);
    return month === curM && year === curY;
  }

  m = s.match(/Th√°ng\s*(\d{1,2})\s*[\/\-]?\s*(\d{4})?/i);
  if (m) {
    const month = parseInt(m[1], 10);
    const year  = m[2] ? parseInt(m[2], 10) : curY;
    return month === curM && year === curY;
  }

  return false;
}

/* ===== LOAD FILES ===== */
async function loadFiles() {
  showLoading();
  try {
    const res  = await fetch(API_URL + "?action=files");
    const json = await res.json();
    const list = Array.isArray(json) ? json : (json.files || []);

    fileMenu.innerHTML = "";

    const now  = new Date();
    const curM = now.getMonth() + 1;
    const curY = now.getFullYear();
    let defaultIndex = 0;

    list.forEach((item, idx) => {
      const name = item.name || item.label || ("D√≤ng " + (item.rowIndex || ""));
      const url  = item.url;
      if (!url) return;

      const op = document.createElement("option");
      op.value = url;
      op.textContent = name;
      fileMenu.appendChild(op);

      const monthVal = item.month || item.thang || item.A || null;
      if (monthVal && isCurrentMonthValue(monthVal, curM, curY)) {
        defaultIndex = idx;
      }
    });

    if (fileMenu.options.length > 0) {
      fileMenu.selectedIndex = defaultIndex;
      await loadSheetsForCurrentFile();
    } else {
      hideLoading();
    }
  } catch (err) {
    console.error(err);
    alert("L·ªói t·∫£i danh s√°ch file t·ª´ API.");
    hideLoading();
  }
}

/* ===== LOAD SHEETS ===== */
async function loadSheetsForCurrentFile() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) {
    hideLoading();
    return;
  }

  const id = extractSheetId(fileUrl);
  if (!id) {
    sheetMenu.innerHTML = "";
    hideLoading();
    return;
  }

  showLoading();
  try {
    const res  = await fetch(API_URL + "?action=sheets&fileId=" + encodeURIComponent(id));
const data = await res.json();

const tabs  = data.sheets || [];
const sites = data.sites  || [];

renderSiteStatus(sites);   // ‚≠ê B·∫ÆT BU·ªòC

sheetMenu.innerHTML = "";

const today = new Date();
const day   = today.getDate();
const preferredName = (day <= 15) ? "Ng√†y 1 ƒë·∫øn 15" : "Ng√†y 16 ƒë·∫øn 31";
let preferredGid = null;

tabs.forEach(t => {

      const op = document.createElement("option");
      op.value = t.gid;
      op.textContent = t.name;
      sheetMenu.appendChild(op);

      if (!preferredGid && t.name === preferredName) {
        preferredGid = t.gid;
      }
    });

    if (sheetMenu.options.length > 0) {
      if (preferredGid) {
        sheetMenu.value = preferredGid;
      } else {
        sheetMenu.selectedIndex = 0;
      }
      updateFrame();
    } else {
      hideLoading();
    }
  } catch (err) {
    console.error(err);
    alert("L·ªói t·∫£i danh s√°ch sheet/tabs.");
    hideLoading();
  }
}

/* ===== BUILD URL EDIT#GID ===== */
function buildEditUrl() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) return "";

  const id  = extractSheetId(fileUrl);
  const gid = sheetMenu.value || "";
  if (!id) return fileUrl;

  return `https://docs.google.com/spreadsheets/d/${id}/edit#gid=${gid}`;
}

/* ===== UPDATE IFRAME ===== */
function updateFrame() {
  const url = buildEditUrl();
  if (url) {
    showLoading();
    frame.src = url;
    setTimeout(autoScaleIframe, 300);
  }
}

fileMenu.onchange  = () => { loadSheetsForCurrentFile(); };
sheetMenu.onchange = updateFrame;

/* ===== N√öT S·ª¨A (MOBILE) ===== */
editBtn.onclick = () => {
  const url = buildEditUrl();
  if (url) window.open(url, "_blank");
};

/* ===== N√öT TH∆Ø M·ª§C DRIVE ===== */
driveBtn.onclick = () => {
  window.open("https://drive.google.com/drive/folders/1o3n5GABxec53ANpnS_OaDU1w0M3cGeAX?usp=sharing", "_blank");
};
  function renderSiteStatus(sites) {
  const bar  = document.getElementById("siteStatusBar");
  const list = document.getElementById("statusList");
/* ===== ƒê·ªî SUMMARY V√ÄO D√íNG TR√îI ===== */
const noteDynamic = document.getElementById("statusNoteDynamic");
if (!noteDynamic) return;
noteDynamic.innerHTML = "";
noteDynamic.classList.add("paused"); // ‚≠ê TH√äM D√íNG N√ÄY
sites.forEach(s => {
  let d = s.diffDays;
  let text = "";

  let toText = s.summary
    ? s.summary.replace(/,\s*/g, " | ")
    : "";

  if (typeof d !== "number") {
  text = "üî¥ " + s.maCan + ": kh√¥ng x√°c ƒë·ªãnh ng√†y thi c√¥ng";
}
else if (d === 0 || d === 1) {
  const whenText = (d === 0) ? "H√¥m nay" : "H√¥m qua";

  if (toText) {
    // Chu·∫©n ho√°: "n·ªÅ 3c | th·ª£ s∆°n 2c"
    // ‚Üí "T·ªï n·ªÅ 3 c√¥ng | T·ªï th·ª£ s∆°n 2 c√¥ng"
    const toReadable = toText
      .split("|")
      .map(item => {
        const m = item.trim().match(/^(.+?)\s+(\d+(?:\.\d+)?)c$/i);
        if (!m) return item.trim();
        return "T·ªï " + m[1].trim() + " " + m[2] + " c√¥ng";
      })
      .join(" | ");

    text = "üü¢ " + s.maCan +
           " ‚Äì " + whenText +
           " c√≥ thi c√¥ng g·ªìm: " + toReadable;
  } else {
    text = "üü¢ " + s.maCan +
           " ‚Äì " + whenText +
           " c√≥ thi c√¥ng";
  }
}
else if (d === 2) {
  text = "üü° " + s.maCan + ": ngh·ªâ thi c√¥ng 1 ng√†y";
}
else {
  text = "üî¥ " + s.maCan + ": " + d + " ng√†y kh√¥ng thi c√¥ng";
}
  const span = document.createElement("span");
  span.textContent = text;
  noteDynamic.appendChild(span);
});

  list.innerHTML = "";
  if (!sites.length) {
    bar.style.display = "none";
    return;
  }

  sites.forEach(s => {
    const dot =
      s.status === "green"  ? "dot-green" :
      s.status === "yellow" ? "dot-yellow" :
                              "dot-red";

    const el = document.createElement("div");
    el.className = "site-item";
    el.innerHTML = `
      <span class="site-dot ${dot}"></span>
      <strong>${s.maCan}</strong>
    `;

    el.onclick = () => {
      sheetMenu.value = s.gid;
      updateFrame();
    };

    list.appendChild(el);
  });

  bar.style.display = "block";
}
/* ===== B2: B·∫ÆT ƒê·∫¶U TR√îI KHI LOGO BI·∫æN M·∫§T ===== */
document.addEventListener("dukico-loading-hidden", () => {
  const note = document.getElementById("statusNoteDynamic");
  if (!note) return;

  note.classList.remove("paused");
});

</script>
<div id="siteStatusBar">
  <div class="status-title">C√îNG TR∆Ø·ªúNG ƒêANG HO·∫†T ƒê·ªòNG</div>

  <div class="status-marquee">
    <div id="statusList" class="status-track"></div>
  </div>
<!-- ‚≠ê D√íNG TR√îI ƒê·ªòNG (TH√äM M·ªöI) -->
    <div class="status-note">
  <div class="status-note-track" id="statusNoteDynamic">
    <!-- JS ƒë·ªï n·ªôi dung m·ªõi v√†o ƒë√¢y -->
  </div>
</div>

</div>

</body>
</html>
