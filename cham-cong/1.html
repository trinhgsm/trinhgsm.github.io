<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DUKICO – CHẤM CÔNG GHI NHẬT KÝ AUTO</title>
  <!-- TẮT PINCH ZOOM, CHỈ DÙNG ZOOM NÚT + / - -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <!-- Favicon DK -->
  <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAQAAABecRxxAAAMQ0lEQVR4Ae3dQW7cNhAH4Lz/P6x0fgwlHGawEq+y3OCAXoTr4Wr9PXgCulcbkQCk2BEm90LkAMPx/+qvOB0fOkHn2q+49WCo5L+ymsrDgPV1Y6DT+xr3aMcMBXNte1qNbfXDn/YRh+1WDVYqvfdYv59lSV/TSEux33jjDPsegn+09uXBJgp7wa9u0ed7pKnz03Wx/ju0RduCMsZ/HXXdK5vXnhK/HXXdINvODsPwhj/KgOMrgJUgHgdGXNqBJ38qRAjPR9UCeFVLtZL1NVr7DiIP9N6byN1Nsx3Rp3XIan+FJxuxMxDPZWS9Vyuk3F7S3Uz7Dnk3a1WzN96CBvs1+qsSVqSdz+CA0nVddOZXS6jttuPAHyBs+Sn6TfGsDz3jHK5vVsQt1zAr72XdN6Vq776BF3nf6/Dr7guPmyAnbcW2CYwiVdc+GqORdzdrIW6DCe4kYvI0dzdrIpvCMcvrsSLvUXOc6nqBd3YsY9jhY+cxd6jxoX2HFOKRSbuuSSMzdON3vInM8JStybVNewWWm6XtOD87Qy4V/mQJu1WDVYgv3xNmPR9UCeEVHXDekOVoig3NbS1Ry49j8TjuKTzECszO2vCuxnxO8uKszN7N45ofPmbfXE/CyPwiXlL7sRKqzZo4PM5XsfS5aXoaZySUdkddUTkOcZIZyQQ4Ei5IQf3L7hIwrKyYtJ3zKzbw4edvurIWBLL8GMDIS9ZhDJW60F7uO3cu6UytzszbmWzxubUANe0yoyS9MhUlCT3VkOITkkpFmS6r30YIOCQM7DDDeWGPAHDLcGRIDHuBBhdAu+xr3MNx2qCkCmDYJLdnOjFkMrDXLI4sdAlnOzbIRbkIuWGHNirMRHkRkNvztNFVQVw1Gc7YCOUM3FZRMVAbw1Gc7ICOUJXFJRMBw1Gc4bECUkJXFJRMFh1GczYSKUmPCkhIcY7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUkJXFJhMLB1Gc7ICQUlGSeN5e7/geMHdcN1gx9P7h5e8w49AmwlZDlSv8P++/MOA+DDwHoZ8ULICwhfQ3Gscx3NFuIBZpUKoZX6mE6oPD58x35H0TADaBrZEcDgEaKkMfCjRzOQ64rcXeVUsVTNff7kwh28ykVfoWHz0N7dxyzKk5XxhxL7sRKqzo4PM468Odqy0ZOnLT5O20nT2/QY90PLfsvblSsrfxqSdzDCeWkEaKkRBHJCMlmEkmKQypISQUkJTGXOYJISUoJICKWViypISQUkJpG8gJIchICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIICQUkJZGRvyFkJpG0gZIIBQUAAAAAAAAAAAAAAAAAAAAD4T/APkjYb9YMRo5AAAAAElFTkSuQmCC">

  <style>
    :root {
      --bg-main: #020617;
      --bg-panel: #0f172a;
      --accent: #38bdf8;
      --border-soft: rgba(148,163,184,0.5);
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* ---------- LOCK LAYER ---------- */
    #lockScreen {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    #lockBox {
      width: 100%;
      max-width: 340px;
      background: rgba(15,23,42,0.95);
      padding: 22px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.5);
      text-align: center;
    }
    #lockBox h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    #lockBox p {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    #passwordInput {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #475569;
      outline: none;
      background: #020617;
      color: #fff;
      font-size: 0.9rem;
    }
    #passwordError {
      min-height: 18px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #f97373;
      text-align: left;
    }
    #unlockBtn {
      width: 100%;
      margin-top: 8px;
      padding: 9px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      font-size: 0.86rem;
      cursor: pointer;
    }

    /* ---------- GLOBAL LOADER (GIỮA MÀN HÌNH) ---------- */
    #globalLoader {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.92);
      display: none;               /* bật/tắt bằng JS */
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }
    .loader-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .loader-core {
      position: relative;
      width: 80px;
      height: 80px;
    }
    .loader-ring {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      border: 2px solid rgba(148,163,184,0.25);
      border-top-color: #38bdf8;
      border-right-color: #22c55e;
      animation: loader-spin 0.9s linear infinite;
    }
    .loader-square {
      position: absolute;
      inset: 18px;
      border-radius: 6px;
      border: 1px solid rgba(248,250,252,0.7);
      transform: rotate(12deg);
    }
    .loader-text {
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #e5e7eb;
      opacity: 0.9;
      text-align: center;
      white-space: nowrap;
    }
    @keyframes loader-spin {
      to { transform: rotate(360deg); }
    }

    /* ---------- HEADER ---------- */
    header {
      padding: 8px 10px 6px;
      background: rgba(15,23,42,0.98);
      border-bottom: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-mark {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(#38bdf8,#22c55e,#f97316,#eab308,#38bdf8);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .brand-inner {
      width: 100%;
      height: 100%;
      border-radius: 6px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: #38bdf8;
      font-weight: 700;
      letter-spacing: 0.12em;
    }
    .brand span {
      font-size: 0.9rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* ===== TOOLBAR – THU NHỎ, 1 HÀNG, CÓ THỂ VUỐT NGANG ===== */
    .toolbar {
      display: flex;
      gap: 4px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    select,
    button.small-btn {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 5px 6px;
    }

    select {
      flex: 1 1 auto;
      min-width: 90px;
    }

    button.small-btn {
      flex: 0 0 auto;
      cursor: pointer;
      white-space: nowrap;
      padding: 5px 8px;
    }

    #editBtn {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
      display: inline-block;
    }
    @media (min-width: 768px) {
      #editBtn {
        display: none;
      }
    }

    main {
      flex: 1;
      padding: 6px;
      display: flex;
      min-height: 0;
    }
    .viewer {
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      display: flex;
      flex-direction: column;
    }

    /* KHUNG CHO PHÉP KÉO NGANG + DỌC */
    .iframe-wrap {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .iframe-scale {
      transform-origin: top left;
      display: inline-block;
    }

    iframe {
      border: none;
      background: #020617;
      width: 100%;
      height: 100vh;
    }

    @media (min-width: 768px) {
      header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
      }
      .toolbar {
        overflow-x: visible;
      }
      main { padding: 10px; }
    }
  </style>
</head>
<body>

<!-- LAYER MẬT KHẨU -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>Mật khẩu</h2>
    <p>Nhập mật khẩu để mở viewer.</p>
    <input id="passwordInput" type="password" placeholder="Mật khẩu..." />
    <div id="passwordError"></div>
    <button id="unlockBtn">MỞ</button>
  </div>
</div>

<!-- LOADER GIỮA MÀN -->
<div id="globalLoader">
  <div class="loader-box">
    <div class="loader-core">
      <div class="loader-ring"></div>
      <div class="loader-square"></div>
    </div>
    <div class="loader-text">DUKICO / ĐANG TẢI</div>
  </div>
</div>

<!-- HEADER CHÍNH -->
<header id="topBar" style="display:none;">
  <div class="brand">
    <div class="brand-mark"><div class="brand-inner">DK</div></div>
    <span>DUKICO – Chấm công ghi nhật ký auto</span>
  </div>

  <div class="toolbar">
    <select id="fileMenu"></select>
    <select id="sheetMenu"></select>
    <button id="editBtn" class="small-btn">Sửa</button>
    <button id="driveBtn" class="small-btn">Thư mục Drive</button>
    <button id="zoomOutBtn" class="small-btn">−</button>
    <button id="zoomInBtn" class="small-btn">+</button>
  </div>
</header>

<main>
  <div class="viewer">
    <div class="iframe-wrap">
      <div class="iframe-scale" id="iframeScale">
        <iframe id="sheetFrame"></iframe>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbwHS3lImLY7cFJiWE23fZrTN1i8F_hNwfHLwTVLHuh7o1Erwylyj-KwzI7kVhZtlmWm/exec";
const PASSWORD = "123";
const AUTH_KEY = "dukico_viewer_auth_v1";

/* ===== DOM ===== */
const lockScreen    = document.getElementById("lockScreen");
const passwordInput = document.getElementById("passwordInput");
const passwordError = document.getElementById("passwordError");
const unlockBtn     = document.getElementById("unlockBtn");

const topBar    = document.getElementById("topBar");
const fileMenu  = document.getElementById("fileMenu");
const sheetMenu = document.getElementById("sheetMenu");
const editBtn   = document.getElementById("editBtn");
const driveBtn  = document.getElementById("driveBtn");
const zoomOutBtn = document.getElementById("zoomOutBtn");
const zoomInBtn  = document.getElementById("zoomInBtn");
const frame     = document.getElementById("sheetFrame");
const iframeScaleDiv = document.getElementById("iframeScale");
const globalLoader   = document.getElementById("globalLoader");

/* ===== LOADER CONTROL ===== */
function showLoader() {
  globalLoader.style.display = "flex";
}
function hideLoader() {
  globalLoader.style.display = "none";
}

/* ===== ZOOM STATE ===== */
let zoom = 1;

/* ===== INIT: AUTO UNLOCK NẾU ĐÃ LƯU ===== */
window.addEventListener("load", () => {
  try {
    const auth = localStorage.getItem(AUTH_KEY);
    if (auth === "ok") {
      startApp();
      return;
    }
  } catch (e) {}
});

/* ===== PASSWORD ===== */
unlockBtn.onclick = handleUnlock;
passwordInput.onkeydown = (e) => { if (e.key === "Enter") handleUnlock(); };

function handleUnlock() {
  const pass = passwordInput.value.trim();
  if (pass === PASSWORD) {
    try {
      localStorage.setItem(AUTH_KEY, "ok");
    } catch (e) {}
    startApp();
  } else {
    passwordError.textContent = "Sai mật khẩu!";
  }
}

function startApp() {
  passwordError.textContent = "";
  lockScreen.style.display = "none";
  topBar.style.display = "flex";
  showLoader();
  loadFiles();
  applyScale();
}

/* ===== APPLY SCALE ===== */
function applyScale() {
  if (!iframeScaleDiv) return;
  iframeScaleDiv.style.transform = "scale(" + zoom + ")";
}

window.addEventListener("resize", applyScale);

/* ===== NÚT ZOOM +/- ===== */
function changeZoom(delta) {
  zoom += delta;
  if (zoom < 0.5) zoom = 0.5;
  if (zoom > 2)   zoom = 2;
  applyScale();
}

zoomOutBtn.onclick = () => changeZoom(-0.1);
zoomInBtn.onclick  = () => changeZoom(+0.1);

/* Khi iframe load xong thì tắt loader */
frame.addEventListener("load", () => {
  if (frame.src && frame.src !== "about:blank") {
    hideLoader();
  }
});

/* ===== UTIL ===== */
function extractSheetId(url) {
  if (!url) return null;
  const m = String(url).match(/\/d\/([a-zA-Z0-9\-_]+)/);
  return m ? m[1] : null;
}

function isCurrentMonthValue(val, curM, curY) {
  if (!val) return false;

  if (val instanceof Date) {
    return (val.getMonth() + 1 === curM) && (val.getFullYear() === curY);
  }

  const s = String(val).trim();

  let m = s.match(/^(\d{1,2})\s*[\/\-]\s*(\d{4})$/);
  if (m) {
    const month = parseInt(m[1], 10);
    const year  = parseInt(m[2], 10);
    return month === curM && year === curY;
  }

  m = s.match(/^(\d{4})\s*[\/\-]\s*(\d{1,2})$/);
  if (m) {
    const year  = parseInt(m[1], 10);
    const month = parseInt(m[2], 10);
    return month === curM && year === curY;
  }

  m = s.match(/Tháng\s*(\d{1,2})\s*[\/\-]?\s*(\d{4})?/i);
  if (m) {
    const month = parseInt(m[1], 10);
    const year  = m[2] ? parseInt(m[2], 10) : curY;
    return month === curM && year === curY;
  }

  return false;
}

/* ===== LOAD FILES ===== */
async function loadFiles() {
  showLoader();
  try {
    const res  = await fetch(API_URL + "?action=files");
    const json = await res.json();
    const list = Array.isArray(json) ? json : (json.files || []);

    fileMenu.innerHTML = "";

    const now  = new Date();
    const curM = now.getMonth() + 1;
    const curY = now.getFullYear();
    let defaultIndex = 0;

    list.forEach((item, idx) => {
      const name = item.name || item.label || ("Dòng " + (item.rowIndex || ""));
      const url  = item.url;
      if (!url) return;

      const op = document.createElement("option");
      op.value = url;
      op.textContent = name;
      fileMenu.appendChild(op);

      const monthVal = item.month || item.thang || item.A || null;
      if (monthVal && isCurrentMonthValue(monthVal, curM, curY)) {
        defaultIndex = idx;
      }
    });

    if (fileMenu.options.length > 0) {
      fileMenu.selectedIndex = defaultIndex;
      await loadSheetsForCurrentFile();
    } else {
      hideLoader();
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi tải danh sách file từ API.");
    hideLoader();
  }
}

/* ===== LOAD SHEETS ===== */
async function loadSheetsForCurrentFile() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) {
    hideLoader();
    return;
  }

  const id = extractSheetId(fileUrl);
  if (!id) {
    sheetMenu.innerHTML = "";
    hideLoader();
    return;
  }

  showLoader();
  try {
    const res  = await fetch(API_URL + "?action=sheets&fileId=" + encodeURIComponent(id));
    const tabs = await res.json();

    sheetMenu.innerHTML = "";

    const today = new Date();
    const day   = today.getDate();
    const preferredName = (day <= 15) ? "Ngày 1 đến 15" : "Ngày 16 đến 31";
    let preferredGid = null;

    tabs.forEach(t => {
      const op = document.createElement("option");
      op.value = t.gid;
      op.textContent = t.name;
      sheetMenu.appendChild(op);

      if (!preferredGid && t.name === preferredName) {
        preferredGid = t.gid;
      }
    });

    if (sheetMenu.options.length > 0) {
      if (preferredGid) {
        sheetMenu.value = preferredGid;
      } else {
        sheetMenu.selectedIndex = 0;
      }
      updateFrame();
    } else {
      hideLoader();
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi tải danh sách sheet/tabs.");
    hideLoader();
  }
}

/* ===== BUILD URL EDIT#GID ===== */
function buildEditUrl() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) return "";

  const id  = extractSheetId(fileUrl);
  const gid = sheetMenu.value || "";
  if (!id) return fileUrl;

  return `https://docs.google.com/spreadsheets/d/${id}/edit#gid=${gid}`;
}

/* ===== UPDATE IFRAME ===== */
function updateFrame() {
  const url = buildEditUrl();
  if (url) {
    showLoader();
    frame.src = url;
    setTimeout(applyScale, 300);
  }
}

fileMenu.onchange  = () => { loadSheetsForCurrentFile(); };
sheetMenu.onchange = updateFrame;

/* ===== NÚT SỬA (MOBILE) ===== */
editBtn.onclick = () => {
  const url = buildEditUrl();
  if (url) window.open(url, "_blank");
};

/* ===== NÚT THƯ MỤC DRIVE ===== */
driveBtn.onclick = () => {
  window.open("https://drive.google.com/drive/folders/1o3n5GABxec53ANpnS_OaDU1w0M3cGeAX?usp=sharing", "_blank");
};
</script>

</body>
</html>
