<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>DUKICO – CHẤM CÔNG GHI NHẬT KÝ AUTO</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --border:rgba(148,163,184,.4);
  --accent:#38bdf8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,sans-serif;
  background:var(--bg);
  color:#e5e7eb;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
header{
  background:var(--panel);
  border-bottom:1px solid #1f2937;
  padding:8px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.brand{
  display:flex;
  gap:8px;
  align-items:center;
}
.brand b{color:var(--accent)}
.toolbar{
  display:flex;
  gap:6px;
}
select,button{
  background:#020617;
  border:1px solid var(--border);
  color:#e5e7eb;
  border-radius:8px;
  padding:4px 6px;
  font-size:12px;
  cursor:pointer;
}
button{white-space:nowrap}

/* ===== MAIN ===== */
main{
  flex:1;
  display:flex;
  overflow:hidden;
}

/* ===== VIEWER ===== */
.viewer{
  flex:1;
  display:flex;
}
.iframe-wrap{
  flex:1;
  overflow:auto;
}
iframe{
  width:1200px;
  height:100%;
  border:none;
}

/* ===== REPORT DASHBOARD ===== */
#reportDashboard{
  flex:1;
  display:none;
  padding:12px;
  overflow:auto;
}
.kpi{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
}
.kpi-card{
  background:#020617;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.kpi-card h3{
  margin:0;
  font-size:12px;
  color:#9ca3af;
}
.kpi-card b{
  font-size:22px;
  color:#38bdf8;
}
#reportList{
  margin-top:14px;
  background:#020617;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
#reportList div{
  padding:6px 0;
  border-bottom:1px dashed #1f2937;
  font-size:13px;
}
#reportList div:last-child{border-bottom:none}

/* ===== STATUS BAR ===== */
#siteStatusBar{
  position:fixed;
  left:0;right:0;bottom:0;
  background:#020617;
  border-top:1px solid var(--border);
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 10px;
}
.status-title{
  font-size:12px;
  color:var(--accent);
  white-space:nowrap;
}
.status-marquee{
  overflow:hidden;
  flex:1;
}
.status-track{
  display:flex;
  gap:10px;
  animation:scroll 30s linear infinite;
}
.site-item{
  display:flex;
  gap:6px;
  align-items:center;
  padding:4px 8px;
  border-radius:999px;
  background:#020617;
  border:1px solid var(--border);
  font-size:12px;
}
.site-dot{
  width:8px;height:8px;border-radius:50%;
}
.dot-green{background:#22c55e}
.dot-yellow{background:#eab308}
.dot-red{background:#ef4444}

@keyframes scroll{
  from{transform:translateX(100%)}
  to{transform:translateX(-100%)}
}
</style>
</head>

<body>

<header>
  <div class="brand">
    <b>DUKICO</b>
    <span>Chấm công ghi nhật ký auto</span>
  </div>
  <div class="toolbar">
    <select id="fileMenu"></select>
    <select id="sheetMenu"></select>
    <button id="viewBtn">Xem</button>
    <button id="reportBtn">Báo cáo</button>
  </div>
</header>

<main>
  <!-- VIEWER -->
  <div class="viewer" id="viewer">
    <div class="iframe-wrap">
      <iframe id="sheetFrame"></iframe>
    </div>
  </div>

  <!-- REPORT -->
  <div id="reportDashboard">
    <div class="kpi">
      <div class="kpi-card">
        <h3>TỔNG CÔNG</h3>
        <b id="kpiTotal">0</b>
      </div>
      <div class="kpi-card">
        <h3>SỐ CĂN</h3>
        <b id="kpiCount">0</b>
      </div>
      <div class="kpi-card">
        <h3>TB / CĂN</h3>
        <b id="kpiAvg">0</b>
      </div>
    </div>
    <div id="reportList"></div>
  </div>
</main>

<!-- STATUS BAR -->
<div id="siteStatusBar">
  <div class="status-title">CÔNG TRƯỜNG</div>
  <div class="status-marquee">
    <div class="status-track" id="statusList"></div>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzZRE8_2j2Tgk5w0QRHmAC2ertSS1G4jeG8U0KoYyo6KdaabekkW7GITgwv9uDaF9X5/exec";

const fileMenu=document.getElementById("fileMenu");
const sheetMenu=document.getElementById("sheetMenu");
const frame=document.getElementById("sheetFrame");
const statusList=document.getElementById("statusList");

const viewer=document.getElementById("viewer");
const report=document.getElementById("reportDashboard");

document.getElementById("viewBtn").onclick=()=>{
  report.style.display="none";
  viewer.style.display="flex";
};

document.getElementById("reportBtn").onclick=()=>{
  viewer.style.display="none";
  report.style.display="block";
  loadReport();
};

async function loadFiles(){
  const res=await fetch(API_URL+"?action=files");
  const data=await res.json();
  fileMenu.innerHTML="";
  data.forEach(f=>{
    const op=document.createElement("option");
    op.value=f.url;
    op.textContent=f.name;
    fileMenu.appendChild(op);
  });
  loadSheets();
}

async function loadSheets(){
  const id=(fileMenu.value.match(/\/d\/([^/]+)/)||[])[1];
  if(!id)return;
  const res=await fetch(API_URL+"?action=sheets&fileId="+id);
  const data=await res.json();
  sheetMenu.innerHTML="";
  data.sheets.forEach(s=>{
    const op=document.createElement("option");
    op.value=s.gid;
    op.textContent=s.name;
    sheetMenu.appendChild(op);
  });
  renderStatus(data.sites||[]);
  updateFrame();
}

function updateFrame(){
  const id=(fileMenu.value.match(/\/d\/([^/]+)/)||[])[1];
  frame.src=`https://docs.google.com/spreadsheets/d/${id}/edit#gid=${sheetMenu.value}`;
}

function renderStatus(sites){
  statusList.innerHTML="";
  sites.forEach(s=>{
    const d=s.status==="green"?"dot-green":s.status==="yellow"?"dot-yellow":"dot-red";
    const el=document.createElement("div");
    el.className="site-item";
    el.innerHTML=`<span class="site-dot ${d}"></span><b>${s.maCan}</b>`;
    el.onclick=()=>{
      sheetMenu.value=s.gid;
      updateFrame();
    };
    statusList.appendChild(el);
  });
}

async function loadReport(){
  const res=await fetch(API_URL+"?action=report");
  const data=await res.json();
  const labels=data.labels||[];
  const months=data.months||[];
  const series=data.series||[];
  const idx=months.length-1;
  const vals=series[idx]||[];

  let total=0;
  vals.forEach(v=>total+=v);

  document.getElementById("kpiTotal").textContent=total;
  document.getElementById("kpiCount").textContent=labels.length;
  document.getElementById("kpiAvg").textContent=(labels.length?total/labels.length:0).toFixed(1);

  const list=document.getElementById("reportList");
  list.innerHTML="";
  labels.forEach((l,i)=>{
    const div=document.createElement("div");
    div.textContent=l+" : "+vals[i];
    list.appendChild(div);
  });
}

fileMenu.onchange=loadSheets;
sheetMenu.onchange=updateFrame;

loadFiles();
</script>

</body>
</html>
