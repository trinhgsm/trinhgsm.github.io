<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>DUKICO – CHẤM CÔNG GHI NHẬT KÝ AUTO</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

<link rel="icon" type="image/png"
href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAQAAABecRxxAAAA"/>

<style>
:root{
  --bg-main:#020617;
  --bg-panel:#0f172a;
  --accent:#38bdf8;
  --border-soft:rgba(148,163,184,.5)
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui;
  background:var(--bg-main);color:#e5e7eb;
  min-height:100vh;display:flex;flex-direction:column;
  overflow-x:hidden;padding-bottom:60px
}

/* ===== LOADING ===== */
#loadingOverlay{
  position:fixed;inset:0;
  background:rgba(2,6,23,.92);
  display:none;align-items:center;justify-content:center;
  z-index:9000
}
.loading-ring{
  width:70px;height:70px;border-radius:50%;
  border:3px solid #334155;border-top-color:#38bdf8;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== LOCK ===== */
#lockScreen{
  position:fixed;inset:0;background:rgba(2,6,23,.96);
  display:flex;align-items:center;justify-content:center;
  z-index:9999
}
#lockBox{
  width:100%;max-width:320px;background:#0f172a;
  border:1px solid var(--border-soft);
  border-radius:14px;padding:18px
}

/* ===== HEADER ===== */
header{
  padding:6px 8px;background:#0f172a;
  border-bottom:1px solid #1f2937
}
.toolbar{
  display:flex;gap:4px;flex-wrap:nowrap;overflow-x:auto
}
select,button{
  border-radius:8px;border:1px solid var(--border-soft);
  background:#020617;color:#e5e7eb;
  font-size:.75rem;padding:5px 6px
}
#editBtn{background:#22c55e;color:#022c22}
@media(min-width:768px){#editBtn{display:none}}

/* ===== VIEWER ===== */
main{flex:1;display:flex}
.iframe-wrap{
  width:100%;height:100%;
  overflow-y:auto;overflow-x:hidden;
  touch-action:pan-y
}
.iframe-scale{
  transform-origin:top left;
  width:1200px
}
iframe{width:100%;height:100vh;border:none}

/* ===== TAB TRẠNG THÁI ===== */
#workTab{
  position:fixed;left:0;right:0;bottom:0;
  background:rgba(2,6,23,.96);
  border-top:1px solid #334155;
  padding:6px 10px;
  font-size:.75rem;display:none;
  z-index:7000
}
.workTab-title{
  font-weight:700;letter-spacing:.12em;margin-bottom:4px
}
#workTab-list{
  display:flex;gap:14px;overflow-x:auto;white-space:nowrap
}
.workItem{display:flex;align-items:center;gap:6px}
.dot{
  width:8px;height:8px;border-radius:50%;
  animation:pulse 3s infinite
}
.green{background:#22c55e}
.yellow{background:#facc15}
.red{background:#ef4444}
@keyframes pulse{
  0%{opacity:.4}50%{opacity:1}100%{opacity:.4}
}
</style>
</head>

<body>

<!-- LOADING -->
<div id="loadingOverlay"><div class="loading-ring"></div></div>

<!-- LOCK -->
<div id="lockScreen">
  <div id="lockBox">
    <input id="passwordInput" type="password" placeholder="Mật khẩu" style="width:100%">
    <button id="unlockBtn" style="width:100%;margin-top:8px">MỞ</button>
  </div>
</div>

<header id="topBar" style="display:none">
  <div class="toolbar">
    <select id="fileMenu"></select>
    <select id="sheetMenu"></select>
    <button id="editBtn">Sửa</button>
    <button id="driveBtn">Drive</button>
    <button id="zoomOutBtn">−</button>
    <button id="zoomInBtn">+</button>
  </div>
</header>

<main>
  <div class="iframe-wrap">
    <div class="iframe-scale" id="iframeScale">
      <iframe id="sheetFrame"></iframe>
    </div>
  </div>
</main>

<!-- TAB TRẠNG THÁI -->
<div id="workTab">
  <div class="workTab-title">TRẠNG THÁI THI CÔNG (HÔM QUA)</div>
  <div id="workTab-list"></div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL="https://script.google.com/macros/s/AKfycbwHS3lImLY7cFJiWE23fZrTN1i8F_hNwfHLwTVLHuh7o1Erwylyj-KwzI7kVhZtlmWm/exec";
const PASSWORD="123";
const AUTH_KEY="dukico_auth";
const BASE_WIDTH=1200;

/* ===== DOM ===== */
const frame=document.getElementById("sheetFrame");
const iframeScale=document.getElementById("iframeScale");
const wrap=document.querySelector(".iframe-wrap");
const loading=document.getElementById("loadingOverlay");

/* ===== AUTH ===== */
if(localStorage.getItem(AUTH_KEY)==="ok")startApp();
document.getElementById("unlockBtn").onclick=()=>{
  if(document.getElementById("passwordInput").value===PASSWORD){
    localStorage.setItem(AUTH_KEY,"ok");
    startApp();
  }
};

/* ===== START ===== */
function startApp(){
  document.getElementById("lockScreen").style.display="none";
  document.getElementById("topBar").style.display="block";
  loadFiles();autoScale();
}

/* ===== ZOOM ===== */
let baseScale=1,zoom=1;
function applyScale(){
  iframeScale.style.transform=`scale(${baseScale*zoom})`;
  if(zoom>1){
    wrap.style.overflowX="auto";
    wrap.style.touchAction="pan-x pan-y";
  }else{
    wrap.style.overflowX="hidden";
    wrap.style.touchAction="pan-y";
  }
}
function autoScale(){
  baseScale=Math.min(1,innerWidth/BASE_WIDTH);
  applyScale();
}
zoomInBtn.onclick=()=>{zoom=Math.min(4,zoom+.1);applyScale()}
zoomOutBtn.onclick=()=>{zoom=Math.max(1,zoom-.1);applyScale()}
window.onresize=autoScale;

/* ===== FILE / SHEET ===== */
async function loadFiles(){
  loading.style.display="flex";
  const res=await fetch(API_URL+"?action=files");
  const list=await res.json();
  fileMenu.innerHTML="";
  list.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.url;o.textContent=f.name;
    fileMenu.appendChild(o);
  });
  loadSheets();
}
async function loadSheets(){
  const id=fileMenu.value.match(/\/d\/([^/]+)/)?.[1];
  const res=await fetch(API_URL+"?action=sheets&fileId="+id);
  const tabs=await res.json();
  sheetMenu.innerHTML="";
  tabs.forEach(t=>{
    const o=document.createElement("option");
    o.value=t.gid;o.textContent=t.name;
    sheetMenu.appendChild(o);
  });
  updateFrame();
}
function updateFrame(){
  loading.style.display="flex";
  const id=fileMenu.value.match(/\/d\/([^/]+)/)[1];
  frame.src=`https://docs.google.com/spreadsheets/d/${id}/edit#gid=${sheetMenu.value}`;
}

/* ===== EVENTS ===== */
fileMenu.onchange=loadSheets;
sheetMenu.onchange=updateFrame;
editBtn.onclick=()=>window.open(frame.src,"_blank");
driveBtn.onclick=()=>window.open("https://drive.google.com/drive/folders/1o3n5GABxec53ANpnS_OaDU1w0M3cGeAX","_blank");

frame.onload=()=>{
  loading.style.display="none";
  setTimeout(loadWorkTab,400);
};

/* ===== TAB TRẠNG THÁI ===== */
async function loadWorkTab(){
  try{
    const res=await fetch(API_URL+"?action=workingStatusTab");
    const list=await res.json();
    const wrap=document.getElementById("workTab-list");
    wrap.innerHTML="";
    list.forEach(it=>{
      wrap.innerHTML+=`<div class="workItem">
        <span class="dot ${it.status}"></span>${it.name}
      </div>`;
    });
    document.getElementById("workTab").style.display="block";
  }catch(e){console.error(e)}
}
</script>
</body>
</html>
