<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DUKICO – SHEETS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    :root {
      --bg-main: #020617;
      --bg-panel: #0f172a;
      --accent: #38bdf8;
      --border-soft: rgba(148,163,184,0.5);
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ---------- LOCK LAYER ---------- */
    #lockScreen {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    #lockBox {
      width: 100%;
      max-width: 340px;
      background: rgba(15,23,42,0.95);
      padding: 22px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.5);
      text-align: center;
    }
    #lockBox h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    #lockBox p {
      margin: 0 0 12px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    #passwordInput {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #475569;
      outline: none;
      background: #020617;
      color: #fff;
      font-size: 0.9rem;
    }
    #passwordError {
      min-height: 18px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #f97373;
      text-align: left;
    }
    #unlockBtn {
      width: 100%;
      margin-top: 8px;
      padding: 9px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      font-size: 0.86rem;
      cursor: pointer;
    }

    /* ---------- HEADER ---------- */
    header {
      padding: 8px 10px 6px;
      background: rgba(15,23,42,0.98);
      border-bottom: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-mark {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(#38bdf8,#22c55e,#f97316,#eab308,#38bdf8);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .brand-inner {
      width: 100%;
      height: 100%;
      border-radius: 6px;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: #38bdf8;
      font-weight: 700;
      letter-spacing: 0.12em;
    }
    .brand span {
      font-size: 0.9rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .toolbar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    select, button.small-btn {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 7px 9px;
    }
    select {
      flex: 1;
      min-width: 120px;
    }
    button.small-btn {
      flex: 0 0 auto;
      cursor: pointer;
      white-space: nowrap;
    }
    #editBtn {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
      display: none;
    }
    #zoomBtn {
      background: #38bdf8;
      border-color: #38bdf8;
      color: #02131c;
    }

    main {
      flex: 1;
      padding: 6px;
      display: flex;
    }
    .viewer {
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #020617;
    }

    /* FULLSCREEN */
    body.fullscreen-mode header { display: none; }
    body.fullscreen-mode main   { padding: 0; }
    body.fullscreen-mode .viewer {
      position: fixed;
      inset: 0;
      border-radius: 0;
      z-index: 9990;
    }

    @media (min-width: 768px) {
      header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
      }
      .toolbar {
        flex: 1;
        justify-content: flex-end;
      }
      main { padding: 10px; }
    }
  </style>
</head>
<body>

<!-- LAYER MẬT KHẨU -->
<div id="lockScreen">
  <div id="lockBox">
    <h2>Mở Viewer</h2>
    <p>123: xem, 321: chỉnh sửa.</p>
    <input id="passwordInput" type="password" placeholder="Mật khẩu..." />
    <div id="passwordError"></div>
    <button id="unlockBtn">MỞ</button>
  </div>
</div>

<!-- HEADER CHÍNH -->
<header id="topBar" style="display:none;">
  <div class="brand">
    <div class="brand-mark"><div class="brand-inner">DK</div></div>
    <span>DUKICO – SHEETS</span>
  </div>

  <div class="toolbar">
    <select id="fileMenu"></select>
    <select id="sheetMenu"></select>
    <button id="editBtn" class="small-btn">Chỉnh sửa</button>
    <button id="zoomBtn" class="small-btn">Phóng to</button>
  </div>
</header>

<main>
  <div class="viewer">
    <iframe id="sheetFrame"></iframe>
  </div>
</main>

<script>
/* ===== CONFIG ===== */

// Web app (Viewer) của bạn
const API_URL = "https://script.google.com/macros/s/AKfycbwHS3lImLY7cFJiWE23fZrTN1i8F_hNwfHLwTVLHuh7o1Erwylyj-KwzI7kVhZtlmWm/exec";

// 2 lớp pass
const VIEW_PASSWORD = "123";
const EDIT_PASSWORD = "321";

// Kiểu nhúng: B = dùng edit#gid (không cần publish)
const EMBED_MODE = "B";

/* ===== DOM ===== */
const lockScreen    = document.getElementById("lockScreen");
const passwordInput = document.getElementById("passwordInput");
const passwordError = document.getElementById("passwordError");
const unlockBtn     = document.getElementById("unlockBtn");

const topBar    = document.getElementById("topBar");
const fileMenu  = document.getElementById("fileMenu");
const sheetMenu = document.getElementById("sheetMenu");
const editBtn   = document.getElementById("editBtn");
const zoomBtn   = document.getElementById("zoomBtn");
const frame     = document.getElementById("sheetFrame");

let userMode = "view";
let zoomed   = false;

/* ===== PASSWORD ===== */
unlockBtn.onclick = handleUnlock;
passwordInput.onkeydown = (e) => { if (e.key === "Enter") handleUnlock(); };

function handleUnlock() {
  const pass = passwordInput.value.trim();
  if (pass === VIEW_PASSWORD) {
    userMode = "view";
    startApp();
  } else if (pass === EDIT_PASSWORD) {
    userMode = "edit";
    startApp();
  } else {
    passwordError.textContent = "Sai mật khẩu!";
  }
}

function startApp() {
  passwordError.textContent = "";
  lockScreen.style.display = "none";
  topBar.style.display = "flex";

  if (userMode === "edit") {
    editBtn.style.display = "inline-block";
  }

  loadFiles();
}

/* ===== UTIL ===== */
function extractSheetId(url) {
  if (!url) return null;
  const m = String(url).match(/\/d\/([a-zA-Z0-9\-_]+)/);
  return m ? m[1] : null;
}

/* ===== LOAD FILES ===== */
async function loadFiles() {
  try {
    const res  = await fetch(API_URL + "?action=files");
    const json = await res.json();
    const list = Array.isArray(json) ? json : (json.files || []);

    fileMenu.innerHTML = "";
    list.forEach(item => {
      const name = item.name || item.label || ("Dòng " + (item.rowIndex || ""));
      const url  = item.url;
      if (!url) return;
      const op = document.createElement("option");
      op.value = url;
      op.textContent = name;
      fileMenu.appendChild(op);
    });

    if (list.length > 0) {
      await loadSheetsForCurrentFile();
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi tải danh sách file từ API.");
  }
}

/* ===== LOAD SHEETS (TAB) CỦA 1 FILE ===== */
async function loadSheetsForCurrentFile() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) return;

  const id = extractSheetId(fileUrl);
  if (!id) {
    sheetMenu.innerHTML = "";
    return;
  }

  try {
    const res  = await fetch(API_URL + "?action=sheets&fileId=" + encodeURIComponent(id));
    const tabs = await res.json();

    sheetMenu.innerHTML = "";
    tabs.forEach(t => {
      const op = document.createElement("option");
      op.value = t.gid;
      op.textContent = t.name;
      sheetMenu.appendChild(op);
    });

    if (tabs.length > 0) {
      updateFrame();
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi tải danh sách sheet/tabs.");
  }
}

/* ===== BUILD IFRAME URL (MODE B) ===== */
function buildEmbedUrl() {
  const fileUrl = fileMenu.value;
  if (!fileUrl) return "";

  const id  = extractSheetId(fileUrl);
  const gid = sheetMenu.value || "";

  if (!id) return fileUrl;

  // EMBED_MODE = "B" → dùng edit#gid (không cần publish web)
  // nếu sau này bạn muốn quay về A thì chỉ đổi const EMBED_MODE ở trên
  if (EMBED_MODE === "B") {
    return `https://docs.google.com/spreadsheets/d/${id}/edit#gid=${gid}`;
  } else {
    // dự phòng cho mode A (pubhtml)
    return `https://docs.google.com/spreadsheets/d/${id}/pubhtml?gid=${gid}&single=true&widget=true&headers=false`;
  }
}

/* ===== UPDATE IFRAME ===== */
function updateFrame() {
  const url = buildEmbedUrl();
  if (url) frame.src = url;
}

fileMenu.onchange  = () => { loadSheetsForCurrentFile(); };
sheetMenu.onchange = updateFrame;

/* ===== EDIT MODE ===== */
editBtn.onclick = () => {
  const fileUrl = fileMenu.value;
  const id  = extractSheetId(fileUrl);
  const gid = sheetMenu.value || "";
  if (!id) return;

  const editUrl = `https://docs.google.com/spreadsheets/d/${id}/edit#gid=${gid}`;
  window.open(editUrl, "_blank");
};

/* ===== ZOOM / FULLSCREEN ===== */
zoomBtn.onclick = () => {
  zoomed = !zoomed;
  if (zoomed) {
    document.body.classList.add("fullscreen-mode");
    zoomBtn.textContent = "Thu nhỏ";
  } else {
    document.body.classList.remove("fullscreen-mode");
    zoomBtn.textContent = "Phóng to";
  }
};
</script>

</body>
</html>
