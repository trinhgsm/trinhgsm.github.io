<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload to Google Drive</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    iframe { width: 100%; height: 600px; border: 1px solid #ccc; margin-top: 20px; }
  </style>
</head>
<body>

<h2>Upload file lên Google Drive</h2>

<input type="file" id="fileInput">
<button onclick="upload()">Upload</button>

<p id="status"></p>
<div id="viewer"></div>

<script>
// ==== BẮT ĐẦU CẤU HÌNH ====
const API_URL = "https://script.google.com/macros/s/AKfycbza9m2gVu8QCkF5d0Rcrv17uvmmeqCLCsoMANt_TCvSeAwrR39KtzWBn5jj9bUh7twz/exec";
// ==== HẾT CẤU HÌNH ====


// ====== HÀM UPLOAD (KHÔNG LỖI CÚ PHÁP) ======
function upload() {
  console.log("Upload function START");  // DEBUG 1

  const input = document.getElementById("fileInput");
  const status = document.getElementById("status");
  const viewer = document.getElementById("viewer");

  const file = input.files[0];

  if (!file) {
    alert("Chọn file trước!");
    return;
  }

  console.log("Selected file:", file);  // DEBUG 2

  status.textContent = "Đang upload...";

  const reader = new FileReader();

  reader.onload = function(e) {
    console.log("FileReader DONE");  // DEBUG 3
    const base64 = e.target.result.split(',')[1];

    console.log("Base64 length:", base64.length);  // DEBUG 4

    fetch(API_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fileName: file.name,
        mimeType: file.type || "application/octet-stream",
        base64: base64
      })
    })
    .then(res => {
      console.log("Fetch response:", res);  // DEBUG 5
      return res.json();
    })
    .then(data => {
      console.log("Response JSON:", data);  // DEBUG 6

      if (!data.success) {
        status.textContent = "Lỗi: " + data.error;
        return;
      }

      status.innerHTML =
        'Upload xong: <b>' + data.name + '</b><br>' +
        '<a href="' + data.url + '" target="_blank">Mở trên Drive</a>';

      const previewUrl = `https://drive.google.com/file/d/${data.id}/preview`;

      viewer.innerHTML = `<iframe src="${previewUrl}"></iframe>`;
    })
    .catch(err => {
      console.error("Fetch ERROR:", err);  // DEBUG 7
      status.textContent = "Lỗi fetch: " + err;
    });
  };

  reader.readAsDataURL(file);
}
</script>

</body>
</html>
